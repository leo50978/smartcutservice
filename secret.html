<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administration - Chargement des Produits</title>
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .success-message {
            animation: slideIn 0.5s ease-out;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .input-error {
            border-color: #f87171;
            box-shadow: 0 0 0 3px rgba(248, 113, 113, 0.2);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            transition: all 0.3s ease;
        }
        
        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(79, 70, 229, 0.3);
        }
    </style>
</head>
<body class="py-8 px-4">
    <div class="container mx-auto max-w-6xl">
        <!-- En-tête -->
        <header class="text-center mb-12 fade-in">
            <h1 class="text-4xl font-bold text-white mb-4">Administration SMART CUT SERVICES</h1>
            <p class="text-xl text-white/90 mb-8">Interface de gestion des produits - Chargement dans Firebase</p>
            
            <div class="flex justify-center space-x-4 mb-8">
                <a href="index.html" class="btn-secondary text-white font-medium py-3 px-6 rounded-lg flex items-center">
                    <i class="fas fa-store mr-2"></i> Voir le site
                </a>
                <button id="logout-btn" class="bg-red-500 hover:bg-red-600 text-white font-medium py-3 px-6 rounded-lg flex items-center">
                    <i class="fas fa-sign-out-alt mr-2"></i> Déconnexion
                </button>
            </div>
        </header>

        <!-- Statut de connexion Firebase -->
        <div id="firebase-status" class="glass-card p-6 mb-8">
            <div class="flex items-center justify-between">
                <div>
                    <h2 class="text-2xl font-bold text-gray-800 mb-2">Statut Firebase</h2>
                    <div id="status-indicator" class="flex items-center">
                        <div class="w-3 h-3 rounded-full bg-red-500 mr-2 animate-pulse"></div>
                        <span id="status-text" class="text-gray-600">Connexion en cours...</span>
                    </div>
                </div>
                <div id="product-count" class="hidden">
                    <span class="text-lg font-semibold text-purple-600">Produits en base: <span id="count-number">0</span></span>
                </div>
            </div>
        </div>

        <!-- Principale zone de contenu -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Formulaire d'ajout de produit -->
            <div class="lg:col-span-2">
                <div class="glass-card p-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">Ajouter un nouveau produit</h2>
                    
                    <form id="product-form" class="space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label for="product-name" class="block text-gray-700 font-medium mb-2">
                                    Nom du produit <span class="text-red-500">*</span>
                                </label>
                                <input type="text" id="product-name" required 
                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent transition"
                                       placeholder="Ex: Vinyle Adhésif Premium">
                                <p class="text-sm text-gray-500 mt-1">Nom complet et descriptif du produit</p>
                            </div>
                            
                            <div>
                                <label for="product-price" class="block text-gray-700 font-medium mb-2">
                                    Prix (HTG) <span class="text-red-500">*</span>
                                </label>
                                <input type="number" id="product-price" required min="0" step="100"
                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent transition"
                                       placeholder="Ex: 1500">
                                <p class="text-sm text-gray-500 mt-1">Prix en Gourdes haïtiennes</p>
                            </div>
                        </div>
                        
                        <div>
                            <label for="product-description" class="block text-gray-700 font-medium mb-2">
                                Description <span class="text-red-500">*</span>
                            </label>
                            <textarea id="product-description" required rows="3"
                                      class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent transition"
                                      placeholder="Décrivez le produit en détail..."></textarea>
                            <p class="text-sm text-gray-500 mt-1">Décrivez les caractéristiques et avantages du produit</p>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label for="product-image" class="block text-gray-700 font-medium mb-2">
                                    Nom de l'image <span class="text-red-500">*</span>
                                </label>
                                <input type="text" id="product-image" required
                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent transition"
                                       placeholder="Ex: vinyl-premium.jpg">
                                <p class="text-sm text-gray-500 mt-1">Nom du fichier image (doit exister dans le dossier)</p>
                            </div>
                            
                            <div>
                                <label for="product-category" class="block text-gray-700 font-medium mb-2">
                                    Catégorie <span class="text-red-500">*</span>
                                </label>
                                <select id="product-category" required
                                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent transition">
                                    <option value="">Sélectionner une catégorie</option>
                                    <option value="matériaux">Matériaux</option>
                                    <option value="vêtements">Vêtements</option>
                                    <option value="accessoires">Accessoires</option>
                                    <option value="décoration">Décoration</option>
                                    <option value="autres">Autres</option>
                                </select>
                                <p class="text-sm text-gray-500 mt-1">Catégorie principale du produit</p>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label for="product-stock" class="block text-gray-700 font-medium mb-2">
                                    Stock initial
                                </label>
                                <input type="number" id="product-stock" min="0" value="10"
                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent transition">
                                <p class="text-sm text-gray-500 mt-1">Quantité disponible en stock</p>
                            </div>
                            
                            <div>
                                <label class="block text-gray-700 font-medium mb-2">Options</label>
                                <div class="space-y-2">
                                    <div class="flex items-center">
                                        <input type="checkbox" id="product-featured" class="mr-3 h-5 w-5 text-purple-600 rounded">
                                        <label for="product-featured" class="text-gray-700">Produit en vedette (afficher dans le hero)</label>
                                    </div>
                                    <div class="flex items-center">
                                        <input type="checkbox" id="product-active" checked class="mr-3 h-5 w-5 text-purple-600 rounded">
                                        <label for="product-active" class="text-gray-700">Produit actif (disponible à la vente)</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex space-x-4 pt-4">
                            <button type="submit" id="submit-btn" 
                                    class="btn-primary text-white font-medium py-3 px-8 rounded-lg flex items-center">
                                <i class="fas fa-plus-circle mr-2"></i> Ajouter le produit
                            </button>
                            
                            <button type="button" id="reset-btn" 
                                    class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium py-3 px-8 rounded-lg flex items-center transition">
                                <i class="fas fa-redo mr-2"></i> Réinitialiser
                            </button>
                        </div>
                    </form>
                    
                    <!-- Messages de succès/erreur -->
                    <div id="form-message" class="mt-6 hidden"></div>
                </div>
                
                <!-- Importation en masse -->
                <div class="glass-card p-6 mt-8">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">Importation en masse</h2>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-gray-700 font-medium mb-2">
                                Données JSON des produits
                            </label>
                            <textarea id="bulk-data" rows="8"
                                      class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent transition font-mono text-sm"
                                      placeholder='[
  {
    "name": "Nom du produit 1",
    "price": 1500,
    "description": "Description du produit 1",
    "image": "image1.jpg",
    "category": "matériaux",
    "featured": true
  },
  {
    "name": "Nom du produit 2",
    "price": 2500,
    "description": "Description du produit 2",
    "image": "image2.jpg",
    "category": "vêtements",
    "featured": false
  }
]'></textarea>
                            <p class="text-sm text-gray-500 mt-1">Collez ici un tableau JSON de produits. Format requis pour chaque produit: name, price, description, image, category, featured (boolean)</p>
                        </div>
                        
                        <div class="flex space-x-4">
                            <button type="button" id="bulk-import-btn" 
                                    class="btn-secondary text-white font-medium py-3 px-8 rounded-lg flex items-center">
                                <i class="fas fa-file-import mr-2"></i> Importer les produits
                            </button>
                            
                            <button type="button" id="load-sample-btn" 
                                    class="bg-yellow-500 hover:bg-yellow-600 text-white font-medium py-3 px-8 rounded-lg flex items-center transition">
                                <i class="fas fa-vial mr-2"></i> Charger des exemples
                            </button>
                        </div>
                        
                        <div id="bulk-message" class="hidden mt-4"></div>
                    </div>
                </div>
            </div>
            
            <!-- Panneau latéral: Produits existants et actions -->
            <div class="space-y-8">
                <!-- Liste des produits existants -->
                <div class="glass-card p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-800">Produits existants</h2>
                        <button id="refresh-products-btn" class="text-purple-600 hover:text-purple-800">
                            <i class="fas fa-sync-alt text-lg"></i>
                        </button>
                    </div>
                    
                    <div id="products-list" class="space-y-4 max-h-[500px] overflow-y-auto pr-2">
                        <div class="text-center py-8">
                            <div class="inline-block animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-purple-600 mb-4"></div>
                            <p class="text-gray-600">Chargement des produits...</p>
                        </div>
                    </div>
                    
                    <div class="mt-6 pt-6 border-t border-gray-200">
                        <div class="flex justify-between items-center">
                            <span class="text-gray-700">Total: <span id="total-products" class="font-semibold">0</span> produits</span>
                            <button id="delete-all-btn" class="text-red-600 hover:text-red-800 text-sm font-medium">
                                <i class="fas fa-trash mr-1"></i> Tout supprimer
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Actions rapides -->
                <div class="glass-card p-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">Actions rapides</h2>
                    
                    <div class="space-y-4">
                        <button id="add-default-products-btn" 
                                class="w-full bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white font-medium py-3 px-4 rounded-lg flex items-center justify-center transition transform hover:-translate-y-1">
                            <i class="fas fa-bolt mr-2"></i> Ajouter 8 produits par défaut
                        </button>
                        
                        <button id="export-products-btn" 
                                class="w-full bg-gradient-to-r from-blue-500 to-indigo-600 hover:from-blue-600 hover:to-indigo-700 text-white font-medium py-3 px-4 rounded-lg flex items-center justify-center transition transform hover:-translate-y-1">
                            <i class="fas fa-download mr-2"></i> Exporter les produits (JSON)
                        </button>
                        
                        <button id="view-stats-btn" 
                                class="w-full bg-gradient-to-r from-purple-500 to-pink-600 hover:from-purple-600 hover:to-pink-700 text-white font-medium py-3 px-4 rounded-lg flex items-center justify-center transition transform hover:-translate-y-1">
                            <i class="fas fa-chart-bar mr-2"></i> Voir les statistiques
                        </button>
                    </div>
                </div>
                
                <!-- Instructions -->
                <div class="glass-card p-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Instructions</h2>
                    
                    <div class="space-y-3 text-sm text-gray-600">
                        <div class="flex items-start">
                            <i class="fas fa-info-circle text-purple-600 mt-1 mr-2"></i>
                            <span>Les images doivent être placées dans le même dossier que index.html</span>
                        </div>
                        <div class="flex items-start">
                            <i class="fas fa-info-circle text-purple-600 mt-1 mr-2"></i>
                            <span>Format des noms d'image: lettres minuscules, tirets, pas d'espaces</span>
                        </div>
                        <div class="flex items-start">
                            <i class="fas fa-info-circle text-purple-600 mt-1 mr-2"></i>
                            <span>Exemple: "vinyl-premium.jpg", "custom-shirt.png"</span>
                        </div>
                        <div class="flex items-start">
                            <i class="fas fa-info-circle text-purple-600 mt=1 mr-2"></i>
                            <span>Les produits "featured" apparaissent dans le slider principal</span>
                        </div>
                        <div class="flex items-start">
                            <i class="fas fa-info-circle text-purple-600 mt=1 mr=2"></i>
                            <span>Pour tester: utilisez le bouton "Ajouter 8 produits par défaut"</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Statistiques (caché par défaut) -->
        <div id="stats-panel" class="glass-card p-6 mt-8 hidden">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">Statistiques des produits</h2>
                <button id="close-stats-btn" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <div id="stats-content" class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- Les statistiques seront affichées ici -->
            </div>
        </div>
    </div>
    
    <!-- Modale de confirmation -->
    <div id="confirm-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl max-w-md w-full p-6">
            <div class="text-center">
                <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-exclamation-triangle text-red-600 text-2xl"></i>
                </div>
                <h3 class="text-xl font-bold text-gray-800 mb-2" id="modal-title">Confirmation</h3>
                <p class="text-gray-600 mb-6" id="modal-message">Êtes-vous sûr de vouloir effectuer cette action ?</p>
                
                <div class="flex justify-center space-x-4">
                    <button id="modal-cancel" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium py-2 px-6 rounded-lg transition">
                        Annuler
                    </button>
                    <button id="modal-confirm" class="bg-red-600 hover:bg-red-700 text-white font-medium py-2 px-6 rounded-lg transition">
                        Confirmer
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>

    <script>
        // Configuration Firebase (identique à index.html)
      const firebaseConfig = {
  apiKey: "AIzaSyBZEl66YW2x4csBHfU3BlSDBYxigVQ1U8U",
  authDomain: "izipret-c669d.firebaseapp.com",
  projectId: "izipret-c669d",
  storageBucket: "izipret-c669d.firebasestorage.app",
  messagingSenderId: "483506445126",
  appId: "1:483506445126:web:5dcc2efef0fabb8f0b2347",
  measurementId: "G-0SKSRSFHZ4"
};
        
        // Initialiser Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        
        // État de l'application
        const appState = {
            currentUser: null,
            products: [],
            selectedProduct: null,
            modalCallback: null
        };
        
        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            // Vérifier l'authentification
            checkAuth();
            
            // Initialiser les événements
            initializeEventListeners();
            
            // Charger les produits
            loadProducts();
        });
        
        // Vérifier l'authentification
        function checkAuth() {
            auth.onAuthStateChanged(user => {
                if (user) {
                    // Utilisateur connecté
                    appState.currentUser = user;
                    updateFirebaseStatus(true);
                } else {
                    // Pas d'utilisateur connecté - essayer de se connecter anonymement
                    signInAnonymously();
                }
            });
        }
        
        // Connexion anonyme
        function signInAnonymously() {
            auth.signInAnonymously()
                .then(() => {
                    console.log("Connecté anonymement à Firebase");
                })
                .catch(error => {
                    console.error("Erreur de connexion anonyme:", error);
                    updateFirebaseStatus(false, error.message);
                });
        }
        
        // Mettre à jour l'affichage du statut Firebase
        function updateFirebaseStatus(connected, errorMessage = null) {
            const statusIndicator = document.getElementById('status-indicator');
            const statusText = document.getElementById('status-text');
            const productCount = document.getElementById('product-count');
            
            if (connected) {
                statusIndicator.innerHTML = `
                    <div class="w-3 h-3 rounded-full bg-green-500 mr-2"></div>
                    <span class="text-green-600 font-medium">Connecté à Firebase</span>
                `;
                productCount.classList.remove('hidden');
            } else {
                statusIndicator.innerHTML = `
                    <div class="w-3 h-3 rounded-full bg-red-500 mr-2 animate-pulse"></div>
                    <span class="text-red-600 font-medium">Erreur: ${errorMessage || 'Non connecté'}</span>
                `;
                productCount.classList.add('hidden');
            }
        }
        
        // Initialiser les événements
        function initializeEventListeners() {
            // Formulaire d'ajout de produit
            document.getElementById('product-form').addEventListener('submit', handleAddProduct);
            document.getElementById('reset-btn').addEventListener('click', resetForm);
            
            // Bouton de déconnexion
            document.getElementById('logout-btn').addEventListener('click', handleLogout);
            
            // Importation en masse
            document.getElementById('bulk-import-btn').addEventListener('click', handleBulkImport);
            document.getElementById('load-sample-btn').addEventListener('click', loadSampleData);
            
            // Actions rapides
            document.getElementById('add-default-products-btn').addEventListener('click', addDefaultProducts);
            document.getElementById('export-products-btn').addEventListener('click', exportProducts);
            document.getElementById('view-stats-btn').addEventListener('click', viewStats);
            document.getElementById('close-stats-btn').addEventListener('click', closeStats);
            
            // Rafraîchir la liste des produits
            document.getElementById('refresh-products-btn').addEventListener('click', loadProducts);
            
            // Supprimer tous les produits
            document.getElementById('delete-all-btn').addEventListener('click', confirmDeleteAll);
            
            // Modale de confirmation
            document.getElementById('modal-cancel').addEventListener('click', closeModal);
            document.getElementById('modal-confirm').addEventListener('click', executeModalAction);
        }
        
        // Gérer l'ajout d'un produit
        async function handleAddProduct(e) {
            e.preventDefault();
            
            // Récupérer les valeurs du formulaire
            const productData = {
                name: document.getElementById('product-name').value.trim(),
                price: parseInt(document.getElementById('product-price').value),
                description: document.getElementById('product-description').value.trim(),
                image: document.getElementById('product-image').value.trim(),
                category: document.getElementById('product-category').value,
                stock: parseInt(document.getElementById('product-stock').value) || 10,
                featured: document.getElementById('product-featured').checked,
                active: document.getElementById('product-active').checked,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            // Validation
            if (!validateProductData(productData)) {
                return;
            }
            
            // Désactiver le bouton de soumission
            const submitBtn = document.getElementById('submit-btn');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Ajout en cours...';
            submitBtn.disabled = true;
            
            try {
                // Ajouter le produit à Firestore
                const docRef = await db.collection('products').add(productData);
                
                // Afficher un message de succès
                showMessage('success', `Produit "${productData.name}" ajouté avec succès! ID: ${docRef.id}`);
                
                // Réinitialiser le formulaire
                resetForm();
                
                // Recharger la liste des produits
                loadProducts();
                
            } catch (error) {
                console.error('Erreur lors de l\'ajout du produit:', error);
                showMessage('error', `Erreur: ${error.message}`);
            } finally {
                // Réactiver le bouton
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        }
        
        // Valider les données du produit
        function validateProductData(data) {
            const formMessage = document.getElementById('form-message');
            
            // Réinitialiser les erreurs
            document.querySelectorAll('.input-error').forEach(el => {
                el.classList.remove('input-error');
            });
            
            // Vérifier les champs requis
            const errors = [];
            
            if (!data.name || data.name.length < 2) {
                errors.push('Le nom du produit est requis (min 2 caractères)');
                document.getElementById('product-name').classList.add('input-error');
            }
            
            if (!data.price || isNaN(data.price) || data.price <= 0) {
                errors.push('Le prix doit être un nombre positif');
                document.getElementById('product-price').classList.add('input-error');
            }
            
            if (!data.description || data.description.length < 10) {
                errors.push('La description est requise (min 10 caractères)');
                document.getElementById('product-description').classList.add('input-error');
            }
            
            if (!data.image || !data.image.includes('.')) {
                errors.push('Le nom de l\'image est requis avec une extension');
                document.getElementById('product-image').classList.add('input-error');
            }
            
            if (!data.category) {
                errors.push('La catégorie est requise');
                document.getElementById('product-category').classList.add('input-error');
            }
            
            // Afficher les erreurs s'il y en a
            if (errors.length > 0) {
                formMessage.innerHTML = `
                    <div class="bg-red-100 border border-red-200 text-red-800 px-4 py-3 rounded-lg">
                        <div class="font-bold mb-1">Veuillez corriger les erreurs suivantes:</div>
                        <ul class="list-disc pl-5 text-sm">
                            ${errors.map(error => `<li>${error}</li>`).join('')}
                        </ul>
                    </div>
                `;
                formMessage.classList.remove('hidden');
                return false;
            }
            
            return true;
        }
        
        // Réinitialiser le formulaire
        function resetForm() {
            document.getElementById('product-form').reset();
            document.getElementById('product-stock').value = '10';
            document.getElementById('product-active').checked = true;
            
            // Cacher les messages d'erreur
            const formMessage = document.getElementById('form-message');
            formMessage.classList.add('hidden');
            
            // Retirer les classes d'erreur
            document.querySelectorAll('.input-error').forEach(el => {
                el.classList.remove('input-error');
            });
        }
        
        // Charger les produits depuis Firebase
        async function loadProducts() {
            try {
                const productsSnapshot = await db.collection('products')
                    .orderBy('createdAt', 'desc')
                    .get();
                
                appState.products = [];
                productsSnapshot.forEach(doc => {
                    const product = doc.data();
                    product.id = doc.id;
                    appState.products.push(product);
                });
                
                renderProductsList();
                updateProductCount();
                
            } catch (error) {
                console.error('Erreur lors du chargement des produits:', error);
                showMessage('error', `Erreur de chargement: ${error.message}`);
            }
        }
        
        // Afficher la liste des produits
        function renderProductsList() {
            const productsList = document.getElementById('products-list');
            
            if (appState.products.length === 0) {
                productsList.innerHTML = `
                    <div class="text-center py-8">
                        <i class="fas fa-box-open text-4xl text-gray-300 mb-4"></i>
                        <p class="text-gray-600">Aucun produit dans la base de données</p>
                        <p class="text-sm text-gray-500 mt-2">Utilisez le formulaire pour ajouter votre premier produit</p>
                    </div>
                `;
                return;
            }
            
            let productsHTML = '';
            
            appState.products.forEach((product, index) => {
                const featuredBadge = product.featured ? 
                    '<span class="bg-yellow-100 text-yellow-800 text-xs font-medium px-2 py-1 rounded ml-2">Vedette</span>' : '';
                
                const activeBadge = product.active ? 
                    '<span class="bg-green-100 text-green-800 text-xs font-medium px-2 py-1 rounded">Actif</span>' :
                    '<span class="bg-red-100 text-red-800 text-xs font-medium px-2 py-1 rounded">Inactif</span>';
                
                productsHTML += `
                    <div class="bg-gray-50 rounded-lg p-4 border border-gray-200 hover:border-purple-300 transition">
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <h3 class="font-bold text-gray-800 truncate">${product.name}</h3>
                                <div class="flex items-center mt-1">
                                    <span class="text-purple-600 font-semibold">${product.price.toLocaleString()} HTG</span>
                                    ${featuredBadge}
                                    ${activeBadge}
                                </div>
                            </div>
                            <div class="flex space-x-2">
                                <button class="edit-product text-blue-600 hover:text-blue-800" data-index="${index}">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="delete-product text-red-600 hover:text-red-800" data-index="${index}">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        <div class="flex items-center text-sm text-gray-600">
                            <span class="bg-gray-200 px-2 py-1 rounded mr-2">${product.category}</span>
                            <span><i class="fas fa-image mr-1"></i> ${product.image}</span>
                        </div>
                    </div>
                `;
            });
            
            productsList.innerHTML = productsHTML;
            
            // Ajouter les événements aux boutons
            document.querySelectorAll('.edit-product').forEach(button => {
                button.addEventListener('click', function() {
                    const index = parseInt(this.getAttribute('data-index'));
                    editProduct(index);
                });
            });
            
            document.querySelectorAll('.delete-product').forEach(button => {
                button.addEventListener('click', function() {
                    const index = parseInt(this.getAttribute('data-index'));
                    confirmDeleteProduct(index);
                });
            });
        }
        
        // Mettre à jour le compteur de produits
        function updateProductCount() {
            document.getElementById('count-number').textContent = appState.products.length;
            document.getElementById('total-products').textContent = appState.products.length;
        }
        
        // Éditer un produit
        function editProduct(index) {
            const product = appState.products[index];
            
            // Remplir le formulaire avec les données du produit
            document.getElementById('product-name').value = product.name;
            document.getElementById('product-price').value = product.price;
            document.getElementById('product-description').value = product.description;
            document.getElementById('product-image').value = product.image;
            document.getElementById('product-category').value = product.category;
            document.getElementById('product-stock').value = product.stock || 10;
            document.getElementById('product-featured').checked = product.featured || false;
            document.getElementById('product-active').checked = product.active !== false;
            
            // Changer le texte du bouton de soumission
            const submitBtn = document.getElementById('submit-btn');
            submitBtn.innerHTML = '<i class="fas fa-save mr-2"></i> Mettre à jour';
            
            // Stocker l'ID du produit à modifier
            appState.selectedProduct = product.id;
            
            // Modifier l'action du formulaire
            document.getElementById('product-form').onsubmit = function(e) {
                e.preventDefault();
                updateProduct(appState.selectedProduct);
            };
            
            // Scroll vers le formulaire
            document.getElementById('product-form').scrollIntoView({ behavior: 'smooth' });
        }
        
        // Mettre à jour un produit
        async function updateProduct(productId) {
            // Récupérer les valeurs du formulaire
            const productData = {
                name: document.getElementById('product-name').value.trim(),
                price: parseInt(document.getElementById('product-price').value),
                description: document.getElementById('product-description').value.trim(),
                image: document.getElementById('product-image').value.trim(),
                category: document.getElementById('product-category').value,
                stock: parseInt(document.getElementById('product-stock').value) || 10,
                featured: document.getElementById('product-featured').checked,
                active: document.getElementById('product-active').checked,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            // Validation
            if (!validateProductData(productData)) {
                return;
            }
            
            // Désactiver le bouton de soumission
            const submitBtn = document.getElementById('submit-btn');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Mise à jour...';
            submitBtn.disabled = true;
            
            try {
                // Mettre à jour le produit dans Firestore
                await db.collection('products').doc(productId).update(productData);
                
                // Afficher un message de succès
                showMessage('success', `Produit "${productData.name}" mis à jour avec succès!`);
                
                // Réinitialiser le formulaire
                resetForm();
                
                // Recharger la liste des produits
                loadProducts();
                
                // Restaurer l'action d'ajout
                submitBtn.innerHTML = '<i class="fas fa-plus-circle mr-2"></i> Ajouter le produit';
                document.getElementById('product-form').onsubmit = handleAddProduct;
                appState.selectedProduct = null;
                
            } catch (error) {
                console.error('Erreur lors de la mise à jour du produit:', error);
                showMessage('error', `Erreur: ${error.message}`);
            } finally {
                // Réactiver le bouton
                submitBtn.disabled = false;
            }
        }
        
        // Confirmer la suppression d'un produit
        function confirmDeleteProduct(index) {
            const product = appState.products[index];
            
            showModal(
                `Supprimer le produit "${product.name}"?`,
                "Cette action est irréversible. Le produit sera définitivement supprimé de la base de données.",
                function() {
                    deleteProduct(product.id, product.name);
                }
            );
        }
        
        // Supprimer un produit
        async function deleteProduct(productId, productName) {
            try {
                await db.collection('products').doc(productId).delete();
                
                showMessage('success', `Produit "${productName}" supprimé avec succès!`);
                loadProducts();
                
            } catch (error) {
                console.error('Erreur lors de la suppression du produit:', error);
                showMessage('error', `Erreur: ${error.message}`);
            }
        }
        
        // Gérer l'importation en masse
        async function handleBulkImport() {
            const bulkDataText = document.getElementById('bulk-data').value.trim();
            
            if (!bulkDataText) {
                showMessage('error', 'Veuillez saisir des données JSON valides');
                return;
            }
            
            try {
                const products = JSON.parse(bulkDataText);
                
                if (!Array.isArray(products)) {
                    showMessage('error', 'Les données doivent être un tableau JSON');
                    return;
                }
                
                // Désactiver le bouton
                const importBtn = document.getElementById('bulk-import-btn');
                const originalText = importBtn.innerHTML;
                importBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Importation...';
                importBtn.disabled = true;
                
                // Ajouter chaque produit
                let successCount = 0;
                let errorCount = 0;
                
                for (const product of products) {
                    try {
                        // Ajouter les timestamps
                        const productWithTimestamps = {
                            ...product,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                            stock: product.stock || 10,
                            active: product.active !== false
                        };
                        
                        await db.collection('products').add(productWithTimestamps);
                        successCount++;
                    } catch (error) {
                        console.error('Erreur avec un produit:', error);
                        errorCount++;
                    }
                }
                
                // Afficher le résultat
                const bulkMessage = document.getElementById('bulk-message');
                bulkMessage.innerHTML = `
                    <div class="bg-green-100 border border-green-200 text-green-800 px-4 py-3 rounded-lg">
                        Importation terminée! <br>
                        <span class="font-semibold">${successCount}</span> produits ajoutés avec succès. <br>
                        ${errorCount > 0 ? `<span class="font-semibold">${errorCount}</span> erreurs.` : ''}
                    </div>
                `;
                bulkMessage.classList.remove('hidden');
                
                // Recharger la liste des produits
                loadProducts();
                
            } catch (error) {
                const bulkMessage = document.getElementById('bulk-message');
                bulkMessage.innerHTML = `
                    <div class="bg-red-100 border border-red-200 text-red-800 px-4 py-3 rounded-lg">
                        Erreur de parsing JSON: ${error.message}
                    </div>
                `;
                bulkMessage.classList.remove('hidden');
            } finally {
                // Réactiver le bouton
                const importBtn = document.getElementById('bulk-import-btn');
                importBtn.innerHTML = originalText;
                importBtn.disabled = false;
            }
        }
        
        // Charger des exemples de données
        function loadSampleData() {
            const sampleData = [
                {
                    name: "Vinyle Adhésif Premium",
                    price: 1500,
                    description: "Vinyle adhésif de haute qualité pour découpe précise, résistant aux intempéries et aux UV.",
                    image: "vinyl-premium.jpg",
                    category: "matériaux",
                    featured: true,
                    stock: 50
                },
                {
                    name: "Maillot Personnalisé Sportif",
                    price: 2500,
                    description: "Maillot de sport personnalisable avec votre design, tissu respirant et durable.",
                    image: "jersey-custom.jpg",
                    category: "vêtements",
                    featured: true,
                    stock: 30
                },
                {
                    name: "Tasse Céramique Personnalisée",
                    price: 1200,
                    description: "Tasse céramique de qualité avec impression de votre design, lavable au lave-vaisselle.",
                    image: "mug-custom.jpg",
                    category: "accessoires",
                    featured: true,
                    stock: 40
                },
                {
                    name: "Vinyle Réfléchissant",
                    price: 1800,
                    description: "Vinyle réfléchissant pour signalétique et sécurité, visible de nuit.",
                    image: "vinyl-reflective.jpg",
                    category: "matériaux",
                    featured: false,
                    stock: 25
                },
                {
                    name: "Autocollant Vitrine Entreprise",
                    price: 800,
                    description: "Autocollant personnalisé pour vitrine ou véhicule, résistant aux intempéries.",
                    image: "sticker-business.jpg",
                    category: "décoration",
                    featured: false,
                    stock: 100
                },
                {
                    name: "Casquette Brodée Personnalisée",
                    price: 1800,
                    description: "Casquette ajustable avec broderie de votre logo, tissu de haute qualité.",
                    image: "cap-custom.jpg",
                    category: "vêtements",
                    featured: false,
                    stock: 35
                },
                {
                    name: "Sac Réutilisable Personnalisé",
                    price: 1000,
                    description: "Sac en tissu écologique avec impression de votre design, dimensions 40x40cm.",
                    image: "bag-custom.jpg",
                    category: "accessoires",
                    featured: false,
                    stock: 60
                },
                {
                    name: "Décoration Murale Vinyle",
                    price: 2200,
                    description: "Décoration murale en vinyle découpé, design personnalisable, facile à appliquer.",
                    image: "wall-decor.jpg",
                    category: "décoration",
                    featured: false,
                    stock: 20
                }
            ];
            
            document.getElementById('bulk-data').value = JSON.stringify(sampleData, null, 2);
            showMessage('info', 'Exemples de produits chargés. Cliquez sur "Importer les produits" pour les ajouter à la base.');
        }
        
        // Ajouter les produits par défaut
        async function addDefaultProducts() {
            // Confirmation
            showModal(
                "Ajouter 8 produits par défaut?",
                "Cette action va ajouter 8 produits de démonstration à votre base de données Firebase. Cela peut prendre quelques secondes.",
                async function() {
                    try {
                        // Désactiver le bouton
                        const btn = document.getElementById('add-default-products-btn');
                        const originalText = btn.innerHTML;
                        btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Ajout en cours...';
                        btn.disabled = true;
                        
                        // Charger les données d'exemple
                        loadSampleData();
                        
                        // Importer les données
                        await handleBulkImport();
                        
                        // Réactiver le bouton
                        btn.innerHTML = originalText;
                        btn.disabled = false;
                        
                    } catch (error) {
                        console.error('Erreur lors de l\'ajout des produits par défaut:', error);
                        showMessage('error', `Erreur: ${error.message}`);
                    }
                }
            );
        }
        
        // Exporter les produits au format JSON
        function exportProducts() {
            if (appState.products.length === 0) {
                showMessage('info', 'Aucun produit à exporter');
                return;
            }
            
            // Préparer les données pour l'export
            const exportData = appState.products.map(product => {
                const { id, createdAt, updatedAt, ...rest } = product;
                return rest;
            });
            
            // Créer un blob JSON
            const dataStr = JSON.stringify(exportData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            
            // Créer un lien de téléchargement
            const downloadLink = document.createElement('a');
            downloadLink.href = URL.createObjectURL(dataBlob);
            downloadLink.download = `smartcut-products-${new Date().toISOString().slice(0, 10)}.json`;
            
            // Simuler un clic pour déclencher le téléchargement
            document.body.appendChild(downloadLink);
            downloadLink.click();
            document.body.removeChild(downloadLink);
            
            showMessage('success', `Export réussi! ${appState.products.length} produits téléchargés.`);
        }
        
        // Afficher les statistiques
        function viewStats() {
            if (appState.products.length === 0) {
                showMessage('info', 'Aucun produit à analyser');
                return;
            }
            
            // Calculer les statistiques
            const totalProducts = appState.products.length;
            const totalValue = appState.products.reduce((sum, p) => sum + p.price, 0);
            const avgPrice = totalValue / totalProducts;
            
            // Compter par catégorie
            const categoryCount = {};
            appState.products.forEach(p => {
                categoryCount[p.category] = (categoryCount[p.category] || 0) + 1;
            });
            
            // Produits en vedette
            const featuredCount = appState.products.filter(p => p.featured).length;
            
            // Générer le HTML des statistiques
            const statsHTML = `
                <div class="bg-blue-50 p-6 rounded-xl">
                    <h3 class="text-lg font-bold text-blue-800 mb-4">Aperçu général</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between">
                            <span class="text-blue-700">Total des produits</span>
                            <span class="font-bold text-blue-900">${totalProducts}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-blue-700">Valeur totale</span>
                            <span class="font-bold text-blue-900">${totalValue.toLocaleString()} HTG</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-blue-700">Prix moyen</span>
                            <span class="font-bold text-blue-900">${Math.round(avgPrice).toLocaleString()} HTG</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-blue-700">Produits en vedette</span>
                            <span class="font-bold text-blue-900">${featuredCount}</span>
                        </div>
                    </div>
                </div>
                
                <div class="bg-purple-50 p-6 rounded-xl">
                    <h3 class="text-lg font-bold text-purple-800 mb-4">Par catégorie</h3>
                    <div class="space-y-3">
                        ${Object.entries(categoryCount).map(([category, count]) => `
                            <div class="flex justify-between">
                                <span class="text-purple-700">${category}</span>
                                <span class="font-bold text-purple-900">${count} produit${count > 1 ? 's' : ''}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
                
                <div class="bg-green-50 p-6 rounded-xl">
                    <h3 class="text-lg font-bold text-green-800 mb-4">Prix</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between">
                            <span class="text-green-700">Produit le moins cher</span>
                            <span class="font-bold text-green-900">${Math.min(...appState.products.map(p => p.price)).toLocaleString()} HTG</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-green-700">Produit le plus cher</span>
                            <span class="font-bold text-green-900">${Math.max(...appState.products.map(p => p.price)).toLocaleString()} HTG</span>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('stats-content').innerHTML = statsHTML;
            document.getElementById('stats-panel').classList.remove('hidden');
        }
        
        // Fermer les statistiques
        function closeStats() {
            document.getElementById('stats-panel').classList.add('hidden');
        }
        
        // Confirmer la suppression de tous les produits
        function confirmDeleteAll() {
            if (appState.products.length === 0) {
                showMessage('info', 'Aucun produit à supprimer');
                return;
            }
            
            showModal(
                "Supprimer TOUS les produits?",
                `Cette action va supprimer définitivement ${appState.products.length} produits de la base de données. Cette action est irréversible.`,
                async function() {
                    try {
                        // Désactiver le bouton
                        const btn = document.getElementById('delete-all-btn');
                        const originalText = btn.innerHTML;
                        btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Suppression...';
                        btn.disabled = true;
                        
                        // Supprimer tous les produits
                        const batch = db.batch();
                        const productsSnapshot = await db.collection('products').get();
                        
                        productsSnapshot.forEach(doc => {
                            batch.delete(doc.ref);
                        });
                        
                        await batch.commit();
                        
                        showMessage('success', `Tous les produits (${appState.products.length}) ont été supprimés.`);
                        loadProducts();
                        
                    } catch (error) {
                        console.error('Erreur lors de la suppression de tous les produits:', error);
                        showMessage('error', `Erreur: ${error.message}`);
                    } finally {
                        // Réactiver le bouton
                        const btn = document.getElementById('delete-all-btn');
                        btn.innerHTML = originalText;
                        btn.disabled = false;
                    }
                }
            );
        }
        
        // Gérer la déconnexion
        function handleLogout() {
            auth.signOut()
                .then(() => {
                    showMessage('success', 'Déconnexion réussie');
                    setTimeout(() => {
                        // Rediriger vers la page d'accueil
                        window.location.href = 'index.html';
                    }, 1500);
                })
                .catch(error => {
                    console.error('Erreur lors de la déconnexion:', error);
                    showMessage('error', `Erreur: ${error.message}`);
                });
        }
        
        // Afficher un message
        function showMessage(type, text) {
            const formMessage = document.getElementById('form-message');
            
            let bgColor, textColor, icon;
            switch (type) {
                case 'success':
                    bgColor = 'bg-green-100 border-green-200';
                    textColor = 'text-green-800';
                    icon = 'fa-check-circle';
                    break;
                case 'error':
                    bgColor = 'bg-red-100 border-red-200';
                    textColor = 'text-red-800';
                    icon = 'fa-exclamation-circle';
                    break;
                case 'info':
                    bgColor = 'bg-blue-100 border-blue-200';
                    textColor = 'text-blue-800';
                    icon = 'fa-info-circle';
                    break;
                default:
                    bgColor = 'bg-gray-100 border-gray-200';
                    textColor = 'text-gray-800';
                    icon = 'fa-info-circle';
            }
            
            formMessage.innerHTML = `
                <div class="${bgColor} border ${textColor} px-4 py-3 rounded-lg flex items-center">
                    <i class="fas ${icon} mr-3"></i>
                    <span>${text}</span>
                </div>
            `;
            formMessage.classList.remove('hidden');
            
            // Masquer le message après 5 secondes
            setTimeout(() => {
                formMessage.classList.add('hidden');
            }, 5000);
        }
        
        // Afficher une modale de confirmation
        function showModal(title, message, callback) {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-message').textContent = message;
            appState.modalCallback = callback;
            
            document.getElementById('confirm-modal').classList.remove('hidden');
        }
        
        // Fermer la modale
        function closeModal() {
            document.getElementById('confirm-modal').classList.add('hidden');
            appState.modalCallback = null;
        }
        
        // Exécuter l'action de la modale
        function executeModalAction() {
            if (appState.modalCallback) {
                appState.modalCallback();
            }
            closeModal();
        }
    </script>
</body>
</html>